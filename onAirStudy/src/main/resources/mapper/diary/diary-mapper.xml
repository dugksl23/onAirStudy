<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="diary">
 
 	<select id="selectDiaryList" resultType="diary">
	 	select
		   D.*,
		   (select
		        count(*)
		    from 
		        diary_attachment
		    where
		        diary_no = D.no) file_count
		from
		    diary D
		order by 
		    no desc
 	
 	</select>
 	
 	<resultMap type="map" id="diaryMap">
 		<id column="no" property="no"/>
 		<result column="member_id" property="memberId"/>
 		<result column="diary_title" property="diaryTitle"/>
 		<result column="diary_content" property="diaryContent"/>
 		<result column="read_cnt" property="readCnt"/>
 		<result column="diary_date" property="diaryDate"/>
 		<result column="file_count" property="fileCount"/>
 	</resultMap>
 	
 	
 	
 	<insert id="insertDiary">
		insert into
			diary
		values(
			seq_diary_no.nextval,
			#{ memberId },
			#{ diaryTitle },
			default,
			default,
			#{ diaryContent }		
		)
		<selectKey order="AFTER" resultType="_int" keyProperty="no">
			select
				seq_diary_no.currval
			from 
				dual
		</selectKey>
	</insert>
 	<insert id="insertAttachment">
		insert into 
			diary_attachment
		values (
			seq_diary_attach_no.nextval, 
			#{ diaryNo },
			#{ originalFilename },
			#{ renamedFilename }

		)	
	
	</insert>
	<select id="selectOneDiary" resultType="diary">
		select
			*
		from
			diary
		where no = #{no}
	</select>
 	
 	<!-- <select id="selectOneDiaryCollection" resultMap="diaryCollectionMap">
  		select
		    D.*,
		    A.no as "attach_no",
		    A.diary_no,
		    A.original_filename,
		    A.renamed_filename,
		    A.upload_date,
		    A.download_count
		from 
		    diary D
		        left join diary_attachment A
		            on D.no = A.diary_no
		where
		    D.no = #{ no }
  	</select>
  	
	collection을 사용하는 resultMap은 id/result태그를 생략할 수 없다.
  	<resultMap type="diary" id="diaryCollectionMap">
  		<id column="no" property="no"/>
  		<result column="member_id" property="memberId"/>
 		<result column="diary_title" property="diaryTitle"/>
 		<result column="diary_content" property="diaryContent"/>
 		<result column="read_cnt" property="readCnt"/>
 		<result column="diary_date" property="diaryDate"/>
 		<result column="file_count" property="fileCount"/>
  		
  		<collection property="attachList" ofType="attachment">
  			<id column="no" property="no"/>
  			<result column="diary_no" property="boardNo"/>
  			<result column="original_filename" property="originalFilename"/>
  			<result column="renamed_filename" property="renamedFilename"/>
  			<result column="upload_date" property="uploadDate"/>
  			<result column="download_count" property="downloadCount"/>
  			
  		</collection>
  	</resultMap> -->
  	
 	
</mapper>